#!/bin/bash
#   Copyright 2016 MainNerve LLC
#
#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.
#
#
#
#                                 Apache License
#                           Version 2.0, January 2004
#                        http://www.apache.org/licenses/
#
#   TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION
#
#   1. Definitions.
#
#      "License" shall mean the terms and conditions for use, reproduction,
#      and distribution as defined by Sections 1 through 9 of this document.
#
#      "Licensor" shall mean the copyright owner or entity authorized by
#      the copyright owner that is granting the License.
#
#      "Legal Entity" shall mean the union of the acting entity and all
#      other entities that control, are controlled by, or are under common
#      control with that entity. For the purposes of this definition,
#      "control" means (i) the power, direct or indirect, to cause the
#      direction or management of such entity, whether by contract or
#      otherwise, or (ii) ownership of fifty percent (50%) or more of the
#      outstanding shares, or (iii) beneficial ownership of such entity.
#
#      "You" (or "Your") shall mean an individual or Legal Entity
#      exercising permissions granted by this License.
#
#      "Source" form shall mean the preferred form for making modifications,
#      including but not limited to software source code, documentation
#      source, and configuration files.
#
#      "Object" form shall mean any form resulting from mechanical
#      transformation or translation of a Source form, including but
#      not limited to compiled object code, generated documentation,
#      and conversions to other media types.
#
#      "Work" shall mean the work of authorship, whether in Source or
#      Object form, made available under the License, as indicated by a
#      copyright notice that is included in or attached to the work
#      (an example is provided in the Appendix below).
#
#      "Derivative Works" shall mean any work, whether in Source or Object
#      form, that is based on (or derived from) the Work and for which the
#      editorial revisions, annotations, elaborations, or other modifications
#      represent, as a whole, an original work of authorship. For the purposes
#      of this License, Derivative Works shall not include works that remain
#      separable from, or merely link (or bind by name) to the interfaces of,
#      the Work and Derivative Works thereof.
#
#      "Contribution" shall mean any work of authorship, including
#      the original version of the Work and any modifications or additions
#      to that Work or Derivative Works thereof, that is intentionally
#      submitted to Licensor for inclusion in the Work by the copyright owner
#      or by an individual or Legal Entity authorized to submit on behalf of
#      the copyright owner. For the purposes of this definition, "submitted"
#      means any form of electronic, verbal, or written communication sent
#      to the Licensor or its representatives, including but not limited to
#      communication on electronic mailing lists, source code control systems,
#      and issue tracking systems that are managed by, or on behalf of, the
#      Licensor for the purpose of discussing and improving the Work, but
#      excluding communication that is conspicuously marked or otherwise
#      designated in writing by the copyright owner as "Not a Contribution."
#
#      "Contributor" shall mean Licensor and any individual or Legal Entity
#      on behalf of whom a Contribution has been received by Licensor and
#      subsequently incorporated within the Work.
#
#   2. Grant of Copyright License. Subject to the terms and conditions of
#      this License, each Contributor hereby grants to You a perpetual,
#      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
#      copyright license to reproduce, prepare Derivative Works of,
#      publicly display, publicly perform, sublicense, and distribute the
#      Work and such Derivative Works in Source or Object form.
#
#   3. Grant of Patent License. Subject to the terms and conditions of
#      this License, each Contributor hereby grants to You a perpetual,
#      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
#      (except as stated in this section) patent license to make, have made,
#      use, offer to sell, sell, import, and otherwise transfer the Work,
#      where such license applies only to those patent claims licensable
#      by such Contributor that are necessarily infringed by their
#      Contribution(s) alone or by combination of their Contribution(s)
#      with the Work to which such Contribution(s) was submitted. If You
#      institute patent litigation against any entity (including a
#      cross-claim or counterclaim in a lawsuit) alleging that the Work
#      or a Contribution incorporated within the Work constitutes direct
#      or contributory patent infringement, then any patent licenses
#      granted to You under this License for that Work shall terminate
#      as of the date such litigation is filed.
#
#   4. Redistribution. You may reproduce and distribute copies of the
#      Work or Derivative Works thereof in any medium, with or without
#      modifications, and in Source or Object form, provided that You
#      meet the following conditions:
#
#      (a) You must give any other recipients of the Work or
#          Derivative Works a copy of this License; and
#
#      (b) You must cause any modified files to carry prominent notices
#          stating that You changed the files; and
#
#      (c) You must retain, in the Source form of any Derivative Works
#          that You distribute, all copyright, patent, trademark, and
#          attribution notices from the Source form of the Work,
#          excluding those notices that do not pertain to any part of
#          the Derivative Works; and
#
#      (d) If the Work includes a "NOTICE" text file as part of its
#          distribution, then any Derivative Works that You distribute must
#          include a readable copy of the attribution notices contained
#          within such NOTICE file, excluding those notices that do not
#          pertain to any part of the Derivative Works, in at least one
#          of the following places: within a NOTICE text file distributed
#          as part of the Derivative Works; within the Source form or
#          documentation, if provided along with the Derivative Works; or,
#          within a display generated by the Derivative Works, if and
#          wherever such third-party notices normally appear. The contents
#          of the NOTICE file are for informational purposes only and
#          do not modify the License. You may add Your own attribution
#          notices within Derivative Works that You distribute, alongside
#          or as an addendum to the NOTICE text from the Work, provided
#          that such additional attribution notices cannot be construed
#          as modifying the License.
#
#      You may add Your own copyright statement to Your modifications and
#      may provide additional or different license terms and conditions
#      for use, reproduction, or distribution of Your modifications, or
#      for any such Derivative Works as a whole, provided Your use,
#      reproduction, and distribution of the Work otherwise complies with
#      the conditions stated in this License.
#
#   5. Submission of Contributions. Unless You explicitly state otherwise,
#      any Contribution intentionally submitted for inclusion in the Work
#      by You to the Licensor shall be under the terms and conditions of
#      this License, without any additional terms or conditions.
#      Notwithstanding the above, nothing herein shall supersede or modify
#      the terms of any separate license agreement you may have executed
#      with Licensor regarding such Contributions.
#
#   6. Trademarks. This License does not grant permission to use the trade
#      names, trademarks, service marks, or product names of the Licensor,
#      except as required for reasonable and customary use in describing the
#      origin of the Work and reproducing the content of the NOTICE file.
#
#   7. Disclaimer of Warranty. Unless required by applicable law or
#      agreed to in writing, Licensor provides the Work (and each
#      Contributor provides its Contributions) on an "AS IS" BASIS,
#      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
#      implied, including, without limitation, any warranties or conditions
#      of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
#      PARTICULAR PURPOSE. You are solely responsible for determining the
#      appropriateness of using or redistributing the Work and assume any
#      risks associated with Your exercise of permissions under this License.
#
#   8. Limitation of Liability. In no event and under no legal theory,
#      whether in tort (including negligence), contract, or otherwise,
#      unless required by applicable law (such as deliberate and grossly
#      negligent acts) or agreed to in writing, shall any Contributor be
#      liable to You for damages, including any direct, indirect, special,
#      incidental, or consequential damages of any character arising as a
#      result of this License or out of the use or inability to use the
#      Work (including but not limited to damages for loss of goodwill,
#      work stoppage, computer failure or malfunction, or any and all
#      other commercial damages or losses), even if such Contributor
#      has been advised of the possibility of such damages.
#
#   9. Accepting Warranty or Additional Liability. While redistributing
#      the Work or Derivative Works thereof, You may choose to offer,
#      and charge a fee for, acceptance of support, warranty, indemnity,
#      or other liability obligations and/or rights consistent with this
#      License. However, in accepting such obligations, You may act only
#      on Your own behalf and on Your sole responsibility, not on behalf
#      of any other Contributor, and only if You agree to indemnify,
#      defend, and hold each Contributor harmless for any liability
#      incurred by, or claims asserted against, such Contributor by reason
#      of your accepting any such warranty or additional liability.
#
#   END OF TERMS AND CONDITIONS
#
#   APPENDIX: How to apply the Apache License to your work.
#
#      To apply the Apache License to your work, attach the following
#      boilerplate notice, with the fields enclosed by brackets "[]"
#      replaced with your own identifying information. (Don't include
#      the brackets!)  The text should be enclosed in the appropriate
#      comment syntax for the file format. We also recommend that a
#      file or class name and description of purpose be included on the
#      same "printed page" as the copyright notice for easier
#      identification within third-party archives.
#
#   Copyright [yyyy] [name of copyright owner]
#
#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.
#
###############################################################################
#
# This script allows to do an unattended install of Netforce Defender
# or the logging piece only (no snort) and also lets switch between
# both installations.
# If a file called extra.sh is sitting right next to this script, it
# will be executed automatically at the end of the installation, allowing
# to install extra stuff or customize the configuration.
#
# It has a few different parameters:
# --install <base/defender/logger>: Installation type. Defender is the default
# --openvas-update <Yes/No>: Do OpenVAS data download/processing
#                            This process takes an hour to do but is
#                            not mandatory to get started and can be
#                            done after the installation
# --from-email: From email for when sending alert emails
# --email-password: Password for the from email.
#                   No single quotes in password or script will fail
# --alert-email: Email address to send the alerts to
# --email-provider: Email provider for the relay.
#                   Supported values: gmail or office365
# --cert-subject: Set the subject line to the following when generating
#                 certificate for Nginx
# --force-install: Force the install even if RAM and disk requirements
#                  are not met.

if [ `id -u` -ne 0 ]; then
	echo "You need root privileges to run this script"
	exit 1
fi

THIS_FILE="${PWD}/$0"
[[ "${0}" =~ ^/ ]] && THIS_FILE="${0}"
CURRENT_DIR="${PWD}"
INSTALL_FILES_DIR="$(dirname ${THIS_FILE})/files"
ETC_MAINNERVE="/etc/mainnerve"

if [ ! -d ${INSTALL_FILES_DIR} ]; then
	echo "Missing files needed for the installation (${INSTALL_FILES_DIR} does not exist), aborting."
	exit 1
fi

IS_FDE=0
[ -n "$(blkid | grep LUKS)" ] && IS_FDE=1

###############################################    FUNCTIONS   ###############################################

SYSTEMD_BASE_DIR=/usr/lib/systemd/system/

function WaitForRoutes {
	# $1: Timeout
	[ -z "$1" ] && return 0
	local TIMEOUT=$1
	while [ $(route -n | grep -E '^0.0.0.0' | wc -l) -eq 0 ];
	do
		sleep 1
		[ ${TIMEOUT} -eq 0 ] && return 0
		TIMEOUT=$((TIMEOUT-1))
	done

	return 1
}

function isInternetUp {
	# $1: Amount of times to check before assuming internet is down
	# Return value: Up: 1. Down: 0

	[ -z "$1" ] && return 0
	local HTTP_SERVICES=('http://www.google.com' 'http://www.apple.com' 'http://www.amazon.com' 'http://www.microsoft.com')
	local WGET_TIMEOUT=20

	if echo $1 | grep "^[0-9]*$" > /dev/null
	then
		local i=0
		for ((i=0;i<$1;i++))
		do
			local ITEM_ID=$(($i % ${#HTTP_SERVICES[@]}))
			wget -T ${WGET_TIMEOUT} -qO- ${HTTP_SERVICES[${ITEM_ID}]} &>/dev/null
			local RET=$?
			[ $RET -eq 0 ] && return 1
		done
	fi

	return 0
}

function store_version_installed {
	local VERSION_INFO=""
	local GIT_FILENAME="$(dirname ${THIS_FILE})/.git/refs/heads/master"
	local VERSION_FILENAME="$(dirname ${THIS_FILE})/VERSION"
	if [ -f ${GIT_FILENAME} ]; then
		VERSION_INFO=" - Revision $(cat ${GIT_FILENAME})"
	elif [ -f ${VERSION_FILENAME} ]; then
		VERSION_INFO=" - Version $(cat ${VERSION_FILENAME})"
	fi

	if [ -f ${ETC_MAINNERVE} ]; then
		grep -E '^Base' ${ETC_MAINNERVE} > ${ETC_MAINNERVE}.bak
		mv ${ETC_MAINNERVE}.bak ${ETC_MAINNERVE}
	else
		echo "Base - Installed on $(date)${VERSION_INFO}" > ${ETC_MAINNERVE}
	fi

	[ ${ND_INSTALL} -eq 1 ] && echo "Netforce Defender - Installed on $(date)${VERSION_INFO}" >> ${ETC_MAINNERVE}
	[ ${LOG_INSTALL} -eq 1 ] && echo "Netforce Logger - Installed on $(date)${VERSION_INFO}" >> ${ETC_MAINNERVE}

	chmod 644 ${ETC_MAINNERVE}
}


function fix_potential_apt_issues {
	echo '[*] Fixing potential APT issues'
	# For some reason, now installing default Ubuntu 14.04 will get you a hash mismatch issue when trying to install stuff. Solution:
	rm -fR /var/lib/apt/lists/*
	rm -fR /var/cache/apt/*
	mkdir -p /var/lib/apt/lists/partial

	# sources.list still has the cd enabled. Disable it.
	sed -i 's/deb cdrom/#deb cdrom/' /etc/apt/sources.list


	apt-get clean
	apt-get autoclean

	apt-get update

	# Make sure apt-get and dpkg are up to date
	DEBIAN_FRONTEND=noninteractive apt-get install dpkg -y
	DEBIAN_FRONTEND=noninteractive apt-get install apt -y
}

function install_kdump {
	# https://www.kernel.org/doc/Documentation/kdump/kdump.txt
	# If crashed, results will be in /var/crash
	echo '[*] Adding crashdump'
	DEBIAN_FRONTEND=noninteractive apt-get install linux-crashdump -y
	sed -i 's|USE_KDUMP=0|USE_KDUMP=1|' /etc/default/kdump-tools
}

function fix_blk_update_request_fd0_errors {
	echo '[*] Fixing fd0 errors'
	[ -z "$(grep -E '^exit 0' /etc/rc.local)" ] && echo 'exit 0' >> /etc/rc.local # Ubuntu 16.04 is lacking the exit 0 at the end of /etc/rc.local
	sed -i "s|^exit 0|rmmod floppy\nexit 0|" /etc/rc.local
	#echo "blacklist floppy" >> /etc/modprobe.d/blacklist.conf
}

function install_ntp {
	echo '[*] Installing NTPd'
	apt-get install ntp -y
	fromdos ${INSTALL_FILES_DIR}/ntp/add_to_ntp.conf
	cat ${INSTALL_FILES_DIR}/ntp/add_to_ntp.conf >> /etc/ntp.conf
}

function install_psmem {
	echo '[*] Installing ps_mem'
	apt-get install python-pip -y
	pip install ps_mem
}

CUSTOM_SHELL_SERVER_PATH=/usr/local/sbin/shell-webserver.py
CUSTOM_SHELL_CLIENT_PATH=/usr/local/bin/shell.py
function install_custom_shell {
	echo '[*] Installing Netforce shell'
	apt-get install python-jsonrpclib tofrodos python-dnspython -y
	mv ${INSTALL_FILES_DIR}/shell/shell.py ${CUSTOM_SHELL_CLIENT_PATH}
	fromdos ${CUSTOM_SHELL_CLIENT_PATH}
	chown root.root ${CUSTOM_SHELL_CLIENT_PATH}
	chmod 755 ${CUSTOM_SHELL_CLIENT_PATH}

	mv ${INSTALL_FILES_DIR}/shell/shell-webserver.py ${CUSTOM_SHELL_SERVER_PATH}
	chown root.root ${CUSTOM_SHELL_SERVER_PATH}
	chmod 750 ${CUSTOM_SHELL_SERVER_PATH}
	fromdos ${CUSTOM_SHELL_SERVER_PATH}

	# Make it run as a daemon
	local SERVICE_FILE=${SYSTEMD_BASE_DIR}/NetforceShell.service
	mkdir -p ${SYSTEMD_BASE_DIR}
	chmod 755 ${SYSTEMD_BASE_DIR}
	mv ${INSTALL_FILES_DIR}/shell/$(basename ${SERVICE_FILE}) ${SERVICE_FILE}
	fromdos ${SERVICE_FILE}
	sed -i "s,CUSTOM_SHELL_SERVER_PATH,${CUSTOM_SHELL_SERVER_PATH}," ${SERVICE_FILE}
	systemctl daemon-reload
	systemctl enable $(basename ${SERVICE_FILE})
}

function add_sysuser_if_not_exist {
	local NEW_USER=sysuser

	# Check if sysuser is already there
	if [ $(grep ${NEW_USER} /etc/passwd | wc -l) -eq 0 ] ; then
		echo "[*] Adding '${NEW_USER}' with access to custom shell"
		install_custom_shell

		# Create user and specify our custom shell
		useradd -s ${CUSTOM_SHELL_CLIENT_PATH} ${NEW_USER}
		local HOME_DIR=$(getent passwd ${NEW_USER} | awk -F: '{print $6}')
		mkdir -p ${HOME_DIR}
		chown -R ${NEW_USER}.${NEW_USER} ${HOME_DIR}

		# And set a default password
		echo -e "${NEW_USER}\n${NEW_USER}" | (passwd ${NEW_USER})

		# Force him to change his pass upon login
		chage -d 0 ${NEW_USER}
	else
		echo "[*] Not adding 'sysuser'. User already present"
	fi
}

function update_motd {
	cp /etc/update-motd.d/00-header /etc/update-motd.d/00-new-header
	chmod -x /etc/update-motd.d/00-header
	sed -i 's/Welcome to/Welcome to Netforce Defender (Open source) on/' /etc/update-motd.d/00-new-header

	chmod -x /etc/update-motd.d/10-help-text

	chmod +x ${INSTALL_FILES_DIR}/motd/10-help-nd
	fromdos ${INSTALL_FILES_DIR}/motd/10-help-nd
	cp ${INSTALL_FILES_DIR}/motd/10-help-nd /etc/update-motd.d

	# It gets updated on reboot
}

function install_postfix {
	if [ ! -d /etc/postfix ]; then
		echo "[*] Installing postfix"
		DEBIAN_FRONTEND=noninteractive apt-get install postfix mailutils -y
		cd /etc/postfix
		mv main.cf main.cf.bak
		mv ${INSTALL_FILES_DIR}/postfix/main.cf.${EMAIL_PROVIDER} main.cf
		fromdos main.cf
		echo "/.*/ ${FROM_EMAIL}" > generic

		# Get relay host and create SASL password file
		local RELAYHOST=$(grep 'relayhost' main.cf | awk '{print $3}')
		echo "${RELAYHOST}  ${FROM_EMAIL}:${EMAIL_PASSWORD}" > sasl_passwd
		unset EMAIL_PASSWORD

		chown -R postfix.postfix /etc/postfix
		postmap /etc/postfix/sasl_passwd
		postmap /etc/postfix/generic
		rm -f sasl_passwd generic

		service postfix stop
		service postfix start
	fi
}

function install_elasticdump {
	which elasticdump 2>/dev/null >/dev/null
	if [ $? -ne 0 ]; then
		echo '[*] Installing Elasticdump'
		apt-get install npm -y
		npm install elasticdump -g

		# Workaround since Elasticdump load 'node' environment and in Ubuntu it is called nodejs
		ln -s $(which nodejs) /usr/local/bin/node
	fi
}

function install_kibana_dashboard {
	echo '[*] Installing Kibana Dashboard'
	install_elasticdump

	# Create index for logstash
	service elasticsearch start
	apt-get install curl -y
	sleep 10
	curl -XDELETE 'http://localhost:9200/.kibana'
	curl -XPUT "localhost:9200/.kibana?pretty"
	local DASHBOARD_JSON="${INSTALL_FILES_DIR}/kibana/dashboard.json"
	elasticdump --input=${DASHBOARD_JSON} --output=http://localhost:9200/.kibana
	rm ${DASHBOARD_JSON}
}

function is_package_installed {
	[ -z "$(dpkg -l | grep -E '^ii' | awk '{print $2}' | grep ^${1}$)" ] && return 0
	return 1
}

function install_openjdk {
	local OPENJDK_VERSION=8
	local OPENJDK_PACKAGE=openjdk-${OPENJDK_VERSION}-jre
	is_package_installed ${OPENJDK_PACKAGE}
	if [ $? -eq 0 ]; then
		echo "Installing ${OPENJDK_PACKAGE}"
		apt-get install ${OPENJDK_PACKAGE} -y
	else
		echo "${OPENJDK_PACKAGE} already installed"
	fi
}

function install_elasticsearch {
	install_openjdk

	echo "[*] Install ElasticSearch"
	apt-get install bc -y # We need bc before installing 
	wget -qO - https://packages.elastic.co/GPG-KEY-elasticsearch | apt-key add -
	if [ -z "$(grep '/elasticsearch' /etc/apt/sources.list.d/elastic.list 2>/dev/null)" ]; then
		echo 'deb http://packages.elastic.co/elasticsearch/2.x/debian stable main' >> /etc/apt/sources.list.d/elastic.list

		# Auto-Update ES memory
		local UPDATE_ES_MEM_SCRIPT="/etc/scripts/updateESmemory"
		mv ${INSTALL_FILES_DIR}/elasticsearch/updateESmemory ${UPDATE_ES_MEM_SCRIPT}
		fromdos ${UPDATE_ES_MEM_SCRIPT}
		chmod +x ${UPDATE_ES_MEM_SCRIPT}
		# Create cronjob
		ln -s ${UPDATE_ES_MEM_SCRIPT} /etc/cron.hourly/updateESmemory

		# Add auto-config update for ElasticSearch
		local DPKG_FILENAME="/etc/scripts/dpkg-auto-update-ES-conf.sh"
		local CUR_LS_VER_STORAGE_FILE=/var/elasticsearch/CURRENT_VERSION
		mkdir -p $(dirname ${DPKG_FILENAME}) 2>/dev/null
		mv ${INSTALL_FILES_DIR}/elasticsearch/dpkg-auto-update-ES-conf.sh ${DPKG_FILENAME}
		# Update link to updateESmemory
		sed -i "s|UPDATE_ES_MEM_SCRIPT|${UPDATE_ES_MEM_SCRIPT}|" ${DPKG_FILENAME}

		chmod +x ${DPKG_FILENAME}
		fromdos ${DPKG_FILENAME}

		mkdir -p $(dirname ${CUR_LS_VER_STORAGE_FILE})
		echo 0 > ${CUR_LS_VER_STORAGE_FILE}

		# Add it to DPKG post invoke
		echo "DPkg::Post-Invoke {\"/bin/bash ${DPKG_FILENAME}\"; };" > /etc/apt/apt.conf.d/99zautoupdateelasticsearchconf

		apt-get update
	fi

	apt-get install elasticsearch curl -y

	service elasticsearch stop
	service elasticsearch start
	# It takes some time to start it
	sleep 30

	# Set-up kibana (including dashboards)
	install_kibana_dashboard

	# Make sure elasticsearch is started at boot time.
	systemctl daemon-reload
	systemctl enable elasticsearch.service
}

LS_KIBANA_AUTO_UPDATE_SCRIPT=/etc/scripts/auto_update_kibana_logstash.sh
function install_kibana {
	# Current version: grep '>Kibana 4' kibana | head -n 1 | awk '{print $2}' | awk -F\< '{print $1}'
	# Installed version: grep 'Kibana 4' /opt/kibana/README.txt | head -n 1 | awk '{print $2}' | awk -F\< '{print $1}'
	local KIBANA_VERSION=4.5
	echo "[*] Install Kibana"
	wget -qO - https://packages.elastic.co/GPG-KEY-elasticsearch | apt-key add -
	if [ -z "$(grep '/kibana' /etc/apt/sources.list.d/elastic.list 2>/dev/null)" ]; then
		echo "deb http://packages.elastic.co/kibana/${KIBANA_VERSION}/debian stable main" >> /etc/apt/sources.list.d/elastic.list
		# TODO: Add to auto-update
		# They need to fix their Release file https://github.com/elastic/kibana/issues/6262
		# https://askubuntu.com/questions/87849/how-to-enable-silent-automatic-updates-for-any-repository
		apt-get update
	fi

	# Install auto install/update Kibana/Logstash
	install_autoupdate_logstash_kibana
	export INSTALL_KIBANA=1
	bash ${LS_KIBANA_AUTO_UPDATE_SCRIPT}
	unset INSTALL_KIBANA

	systemctl daemon-reload
	systemctl enable kibana.service
}

function install_autoupdate_logstash_kibana {
	if [ ! -f ${LS_KIBANA_AUTO_UPDATE_SCRIPT} ]; then
		echo '[*] Installing auto update script for Kibana and Logstash'

		mkdir -p $(dirname ${LS_KIBANA_AUTO_UPDATE_SCRIPT})
		
		mv ${INSTALL_FILES_DIR}/etc_scripts/$(basename ${LS_KIBANA_AUTO_UPDATE_SCRIPT}) ${LS_KIBANA_AUTO_UPDATE_SCRIPT}
		fromdos ${LS_KIBANA_AUTO_UPDATE_SCRIPT}
		chmod +x ${LS_KIBANA_AUTO_UPDATE_SCRIPT}

		echo "5 30 * * *    root    ${LS_KIBANA_AUTO_UPDATE_SCRIPT}" >> /etc/crontab
		service cron restart
	fi
}

function configure_logstash {
	echo '[*] Configure Logstash'
	local LS_CONF_DIR=/etc/logstash/conf.d
	local DB_FILES_DIR=/var/logstash
	mkdir -p ${DB_FILES_DIR}
	chown -R logstash.logstash ${DB_FILES_DIR}

	# install the files depending on the install type chosen
	mv ${INSTALL_FILES_DIR}/logstash/conf.d/* ${LS_CONF_DIR}
	[ ${LOG_INSTALL} -eq 1 ] && rm ${LS_CONF_DIR}/input-snort.conf

	# Rest of the files
	mv ${INSTALL_FILES_DIR}/logstash/*.yaml $(dirname ${LS_CONF_DIR})

	# Make sure permission and file format is OK
	chown -R logstash.logstash $(dirname ${LS_CONF_DIR})
	fromdos ${LS_CONF_DIR}/*
	fromdos $(dirname ${LS_CONF_DIR})/*.yaml
}

function install_logstash {
	install_openjdk

	echo "[*] Installing logstash"
	wget -qO - https://packages.elastic.co/GPG-KEY-elasticsearch | apt-key add -
	if [ -z "$(grep '/logstash' /etc/apt/sources.list.d/elastic.list 2>/dev/null)" ]; then
		echo 'deb http://packages.elastic.co/logstash/2.3/debian stable main' >> /etc/apt/sources.list.d/elastic.list
		apt-get update
		## Add it to auto-update
		#sed -i 's/Unattended-Upgrade::Allowed-Origins {/Unattended-Upgrade::Allowed-Origins {\n\t"Logstash:stable";/' /etc/apt/apt.conf.d/50unattended-upgrades
	fi

	# Auto-Update LS CPU
	local UPDATE_LS_CPU_SCRIPT="/etc/scripts/updateLScpu"
	mv ${INSTALL_FILES_DIR}/etc_scripts/updateLScpu ${UPDATE_LS_CPU_SCRIPT}
	fromdos ${UPDATE_LS_CPU_SCRIPT}
	chmod +x ${UPDATE_LS_CPU_SCRIPT}
	# Create cronjob
	ln -s ${UPDATE_LS_CPU_SCRIPT} /etc/cron.hourly/updateLScpu

	# Install auto install/update Kibana/Logstash
	install_autoupdate_logstash_kibana
	export INSTALL_LOGSTASH=1
	bash ${LS_KIBANA_AUTO_UPDATE_SCRIPT}
	unset INSTALL_LOGSTASH

	# Enable logstash on boot.
	systemctl daemon-reload
	systemctl enable logstash.service
}

function install_snort {
	echo '[*] Installing snort'
	DEBIAN_FRONTEND=noninteractive apt-get install snort -y

	# It used to be 'any', but changed due to using ET rules: Bug #15 in JSON logstash filter
	sed -i 's|DEBIAN_SNORT_HOME_NET="192.168.0.0/16"|DEBIAN_SNORT_HOME_NET="10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,100.64.0.0/10"|' /etc/snort/snort.debian.conf
	# Default to current interface so that it starts
	local SNORT_IFACES="$(route -n | grep -E ^0.0.0.0 | awk '{print $8}' | tr '\n' ' ' | sed 's/[ ]*$//')"
	sed -i "s/DEBIAN_SNORT_INTERFACE=\"eth0\"/DEBIAN_SNORT_INTERFACE=\"${SNORT_IFACES}\"/" /etc/snort/snort.debian.conf
	sed -i 's|^include $RULE_PATH/|#include $RULE_PATH/|' /etc/snort/snort.conf

	# Workaround for snort install failing when unattended
	echo '[*] Fixing snort install'
	apt-get -f install -y
}

function install_ntopng {
	echo '[*] Installing Ntop-ng'
	apt-get install ntopng -y
}

function install_nginx {
	echo '[*] Installing Nginx'
	apt-get install nginx -y

	# Set-up nginx
	rm -f /etc/nginx/sites-enabled/default

	#NGINX_DNS=$(grep -E '^nameserver ' /etc/resolv.conf | head -n 2 | awk '{print $2}')
	#[ -z "${NGINX_DNS}" ] && NGINX_DNS="8.8.8.8 8.8.4.4"
	#NGINX_DNS=$(echo ${NGINX_DNS} | tr '\n' ' ')

	local SERVER_SITE_FILE_AVAIL=/etc/nginx/sites-available/server
	local SERVER_SITE_FILE_ENABLED=/etc/nginx/sites-enabled/server
	mv ${INSTALL_FILES_DIR}/nginx/server.site ${SERVER_SITE_FILE_AVAIL}

	rm -f ${SERVER_SITE_FILE_ENABLED}
	ln -s ${SERVER_SITE_FILE_AVAIL} ${SERVER_SITE_FILE_ENABLED}

	# Generate SSL Cert
	local CERT_GEN_SCRIPT=/etc/scripts/generate_certificate.sh
	mkdir -p $(dirname ${CERT_GEN_SCRIPT})
	cp ${INSTALL_FILES_DIR}/nginx/generate_certificate.sh ${CERT_GEN_SCRIPT}
	fromdos ${CERT_GEN_SCRIPT}
	if [ -n "${CERT_SUBJECT_LINE}" ]; then
		sed -i "s|/C=US/ST=YourState/L=YourCity/O=YourOrganization/CN=Netforce/emailAddress=myemail@example.com|${CERT_SUBJECT_LINE}|" ${CERT_GEN_SCRIPT}
	else
		sed -i "s/myemail@example.com/${ALERT_EMAIL}/" ${CERT_GEN_SCRIPT}
	fi
	chmod +x ${CERT_GEN_SCRIPT}
	bash ${CERT_GEN_SCRIPT}

	# Add basic auth for Nginx
	apt-get install apache2-utils -y
	touch /etc/nginx/.htpasswd
	chown www-data.www-data /etc/nginx/.htpasswd

	service nginx stop
	service nginx start
}

function install_regenerate_ssh_keys {
	echo '[*] Installing script to regenerate SSH keys'
	local REGEN_SSH_SCRIPT=/etc/scripts/regenerate_ssh_keys.sh
	mkdir -p $(dirname ${REGEN_SSH_SCRIPT})
	mv ${INSTALL_FILES_DIR}/etc_scripts/regenerate_ssh_keys.sh ${REGEN_SSH_SCRIPT}
	chmod +x ${REGEN_SSH_SCRIPT}
	fromdos ${REGEN_SSH_SCRIPT}
}

function show_ip_login {
	echo '[*] Installing script to show IP at login prompt'
	local BASE_SCRIPT_FILENAME=show_ip_login_prompt.sh
	local LOGIN_IP_SCRIPT=/etc/scripts/${BASE_SCRIPT_FILENAME}
	mkdir -p $(dirname ${LOGIN_IP_SCRIPT})
	mv ${INSTALL_FILES_DIR}/etc_scripts/${BASE_SCRIPT_FILENAME} ${LOGIN_IP_SCRIPT}
	chmod +x ${LOGIN_IP_SCRIPT}
	fromdos ${LOGIN_IP_SCRIPT}

	[ -z "$(grep -E '^exit 0' /etc/rc.local)" ] && echo 'exit 0' >> /etc/rc.local # Ubuntu 16.04 is lacking the exit 0 at the end of /etc/rc.local
	sed -i "s|^exit 0|${LOGIN_IP_SCRIPT}\nexit 0|" /etc/rc.local
	chmod +x /etc/rc.local
}

AUTOCHMOD_FILENAME=/etc/scripts/autochmod.sh
function install_autochmod {
	if [ -z "${AUTOCHMOD_FILENAME}" ]; then
		echo "Failed to install autochmod, filename is not specified"
	elif [ ! -f "${AUTOCHMOD_FILENAME}" ]; then
		echo "[*] Installing autochmod"
		apt-get install inotify-tools -y
		mkdir -p $(dirname "${AUTOCHMOD_FILENAME}") 2>/dev/null

		mv ${INSTALL_FILES_DIR}/etc_scripts/$(basename ${AUTOCHMOD_FILENAME}) ${AUTOCHMOD_FILENAME}
		chmod +x ${AUTOCHMOD_FILENAME}
		fromdos ${AUTOCHMOD_FILENAME}
	fi
}

function install_rkhunter {

	if [ $(dpkg --get-selections | grep rkhunter | wc -l) -eq 0 ] ; then
		echo '[*] Installing rkhunter and postfix.'
		
		# Install and configure postfix
		install_postfix

		apt-get install rkhunter -y

		# Send an email when rkhunter is done
		fromdos ${INSTALL_FILES_DIR}/rkhunter/append_to_rkhunter_cron
		sed -i "s/myemailfrom@example.com/${FROM_EMAIL}/" ${INSTALL_FILES_DIR}/rkhunter/append_to_rkhunter_cron
		sed -i "s/myemail@example.com/${ALERT_EMAIL}/" ${INSTALL_FILES_DIR}/rkhunter/append_to_rkhunter_cron
		cat ${INSTALL_FILES_DIR}/rkhunter/append_to_rkhunter_cron >> /etc/cron.daily/rkhunter
		rkhunter --update

		# Improve configuration a bit
		echo "[*] Improve default rkhunter configuration"
		sed -i 's/APPEND_LOG=0/APPEND_LOG=1/' /etc/rkhunter.conf
		sed -i 's/DISABLE_TESTS="suspscan hidden_procs deleted_files packet_cap_apps apps"/DISABLE_TESTS="suspscan deleted_files packet_cap_apps apps"/' /etc/rkhunter.conf
		echo 'ALLOWDEVFILE="/dev/.udev/rules.d/root.rules"' >> /etc/rkhunter.conf
		echo 'ALLOWHIDDENDIR="/etc/.java"' >> /etc/rkhunter.conf
		#echo 'ALLOWHIDDENDIR="/etc/.udev"' >> /etc/rkhunter.conf
		#echo 'ALLOWHIDDENFILE="/etc/.initramfs"' >> /etc/rkhunter.conf
		echo 'PKGMGR=DPKG' >> /etc/rkhunter.conf
		sed -i 's/#USE_SYSLOG=authpriv.notice/USE_SYSLOG=authpriv.notice/' /etc/rkhunter.conf
		local RKHUNTER_BIN=$(which rkhunter)
		sed -i "s/'+\[%H:%M:%S]'/--rfc-3339=seconds/" ${RKHUNTER_BIN}

		rkhunter --propupd

		# Autochmod rkhunter log file
		install_autochmod
		[ -z "$(grep -E '^exit 0' /etc/rc.local)" ] && echo 'exit 0' >> /etc/rc.local # Ubuntu 16.04 is lacking the exit 0 at the end of /etc/rc.local
		sed -i "s|^exit 0|${AUTOCHMOD_FILENAME} /var/log/rkhunter.log \&\nexit 0|" /etc/rc.local
		chmod +x /etc/rc.local
	fi
}

function improve_ssh_security {
	echo '[*] Improve SSH security'
	# Improve SSH security
	sed -i 's/HostKey \/etc\/ssh\/ssh_host_dsa_key/#HostKey \/etc\/ssh\/ssh_host_dsa_key/' /etc/ssh/sshd_config
	sed -i 's/HostKey \/etc\/ssh\/ssh_host_ecdsa_key/#HostKey \/etc\/ssh\/ssh_host_ecdsa_key/' /etc/ssh/sshd_config
	sed -i 's/^PermitRootLogin/#PermitRootLogin/' /etc/ssh/sshd_config
	echo 'HashKnownHosts yes' >> /etc/ssh/ssh_config
	ssh-keygen -A

	fromdos ${INSTALL_FILES_DIR}/ssh/append_to_sshd_config
	cat ${INSTALL_FILES_DIR}/ssh/append_to_sshd_config >> /etc/ssh/sshd_config
}

function autoreboot_when_kernel_panic {
	echo '[*] Autoreboot when kernel panics'
	echo 'kernel.panic = 10' > /etc/sysctl.d/20-autoreboot-if-panic.conf
	echo 10 > /proc/sys/kernel/panic
}

function setup_auto_updates {
	echo "[*] Setting up unattended updates"
	apt-get install unattended-upgrades -y
	sed -i 's|//\t"${distro_id}:${distro_codename}-updates";|\t"${distro_id}:${distro_codename}-updates";|' /etc/apt/apt.conf.d/50unattended-upgrades
	sed -i 's|//Unattended-Upgrade::MinimalSteps "true";|Unattended-Upgrade::MinimalSteps "true";|' /etc/apt/apt.conf.d/50unattended-upgrades
	sed -i 's|//Unattended-Upgrade::Mail "root@localhost";|Unattended-Upgrade::Mail "myemail@example.com";|' /etc/apt/apt.conf.d/50unattended-upgrades
	sed -i 's|//Unattended-Upgrade::Mail "root";|Unattended-Upgrade::Mail "myemail@example.com";|' /etc/apt/apt.conf.d/50unattended-upgrades
	sed -i 's|//Unattended-Upgrade::MailOnlyOnError "true";|Unattended-Upgrade::MailOnlyOnError "true";|' /etc/apt/apt.conf.d/50unattended-upgrades

	sed -i "s/myemail@example.com/${ALERT_EMAIL}/" /etc/apt/apt.conf.d/50unattended-upgrades

	# Auto-reboot if updates requires a reboot (and FDE is not present)
	[ ${IS_FDE} -eq 0 ] && sed -i 's|//Unattended-Upgrade::Automatic-Reboot "false";|Unattended-Upgrade::Automatic-Reboot "true";|' /etc/apt/apt.conf.d/50unattended-upgrades

	fromdos ${INSTALL_FILES_DIR}/apt/10periodic
	mv ${INSTALL_FILES_DIR}/apt/10periodic /etc/apt/apt.conf.d/10periodic
}

function increase_network_memory {
	echo "[*] Increasing network memory"
	mv ${INSTALL_FILES_DIR}/sysctl/20-increase-network-memory.conf /etc/sysctl.d/20-increase-network-memory.conf

	# Reload sysctl
	sysctl --system
}

function disable_unneeded_services {
	echo "[*] Disabling unneeded services"
	# Avahi
	systemctl daemon-reload
	systemctl disable avahi-daemon.service
	service avahi-daemon stop
	echo manual > /etc/init/avahi-daemon.override

	# PC Card services
	#update-rc.d avahi-daemon disable
	#service avahi-daemon stop

	# RPC Bind
	systemctl daemon-reload
	systemctl disable rpcbind.service
	service rpcbind stop

	# LXD containers
}

function disable_power_button {
	local POWER_BUTTON_SCRIPT=/etc/acpi/powerbtn.sh
	if [ -f ${POWER_BUTTON_SCRIPT} ]; then
		sed -i 's/# pressed./# pressed.\n\n# Disable shutting off the server when power button is pressed\nexit/' ${POWER_BUTTON_SCRIPT}
		echo "[*] Power button disabled."
	else
		echo "[*] Power button (and script) not present - cannot disable."
	fi
}

function cleanup_install_path {
	is_package_installed realpath
	[ $? -eq 0 ] && apt-get install realpath -y
	is_package_installed realpath
	if [ $? -eq 0 ]; then
		echo "Failed installing realpath, aborting."
		exit 1
	fi
	INSTALL_FILES_DIR="$(realpath -s ${INSTALL_FILES_DIR})"
	chown -R root.root ${INSTALL_FILES_DIR}
}

function configure_curator {
	# Configuring curator to delete indexes older than 3 month
	# Specifying month doesn't work as expected. Eg: current date is October 5th, delete is gonna be until August 31st and not September 4th.
	local CLEAN_OLD_ES_INDEX_SCRIPT=/etc/cron.daily/cleanOldIndicesES
	local CURATOR_ETC=/etc/curator
	echo "[*] Configuring curator"

	mkdir ${CURATOR_ETC}
	mv ${INSTALL_FILES_DIR}/curator/etc/* ${CURATOR_ETC}
	fromdos ${CURATOR_ETC}/*

	mv ${INSTALL_FILES_DIR}/curator/$(basename ${CLEAN_OLD_ES_INDEX_SCRIPT}) ${CLEAN_OLD_ES_INDEX_SCRIPT}
	chmod +x ${CLEAN_OLD_ES_INDEX_SCRIPT}
	fromdos ${CLEAN_OLD_ES_INDEX_SCRIPT}
	sed -i "s,CURATOR_ETC,${CURATOR_ETC}," ${CLEAN_OLD_ES_INDEX_SCRIPT}
}

function install_curator {
	echo "[*] Installing curator"
	wget -qO - https://packages.elastic.co/GPG-KEY-elasticsearch | apt-key add -
	if [ -z "$(grep '/curator' /etc/apt/sources.list.d/elastic.list 2>/dev/null)" ]; then
		echo 'deb http://packages.elastic.co/curator/4/debian stable main' >> /etc/apt/sources.list.d/elastic.list
		## Add it to auto-update
		sed -i 's/Unattended-Upgrade::Allowed-Origins {/Unattended-Upgrade::Allowed-Origins {\n\t"Curator:stable";/' /etc/apt/apt.conf.d/50unattended-upgrades

		apt-get update
	fi

	apt-get install python-elasticsearch-curator -y

	configure_curator
}

function configure_monit {
	local MONIT_CONF_DIR=/etc/monit/conf.d
	echo "[*] Configuring monit"
	sed -i 's/# set mailserver mail.bar.baz,/  set mailserver localhost/' /etc/monit/monitrc
	sed -i 's/# set alert sysadm@foo.bar/ set alert myemail@example.com/' /etc/monit/monitrc
	sed -i 's/#   with start delay 240/   with start delay 240/' /etc/monit/monitrc

	fromdos ${INSTALL_FILES_DIR}/monit/append_to_monitrc
	cat ${INSTALL_FILES_DIR}/monit/append_to_monitrc >> /etc/monit/monitrc
	sed -i "s/myemail@example.com/${ALERT_EMAIL}/g" /etc/monit/monitrc
	mv ${INSTALL_FILES_DIR}/monit/conf.d/* ${MONIT_CONF_DIR}
	# Add alert in case the system needs reboot if FDE is present
	[ ${IS_FDE} -eq 0 ] && rm ${MONIT_CONF_DIR}/reboot-required.conf
	fromdos ${MONIT_CONF_DIR}/*

	# Only start monit if customer name is set
	systemctl daemon-reload
	systemctl disable monit.service
	[ -z "$(grep -E '^exit 0' /etc/rc.local)" ] && echo 'exit 0' >> /etc/rc.local # Ubuntu 16.04 is lacking the exit 0 at the end of /etc/rc.local
	sed -i "s,^exit 0,[ \$(grep '[Customer name]' /etc/monit/monitrc | wc -l) -eq 0 ] \&\& service monit start\nexit 0," /etc/rc.local
	chmod +x /etc/rc.local
}

function install_monit {
	echo "[*] Install Monit"
	apt-get install monit -y
	systemctl daemon-reload
	systemctl enable monit.service
	configure_monit
}

MYSQL_ALERT_LEN=255
MYSQL_DB_NAME="alert"
MYSQL_PASSWORD=""
function install_mysql {
	echo '[*] Installing MySQL for ElastAlert command'
	apt-get install pwgen debconf-utils -y
	MYSQL_PASSWORD=$(pwgen -1 -s 30)
	VERSION="5.7"

	echo mysql-server-${VERSION} mysql-server/root_password password "${MYSQL_PASSWORD}" | debconf-set-selections
	echo mysql-server-${VERSION} mysql-server/root_password_again password "${MYSQL_PASSWORD}" | debconf-set-selections

	DEBIAN_FRONTEND=noninteractive apt-get install mysql-server -y
}

function create_alert_schema_mysql {
	echo '[*] Creating Schema in MySQL for ElastAlert alerts'
	local MYSQL_SCHEMA_FILENAME=${INSTALL_FILES_DIR}/elastalert/alert.mysql
	MYSQL_DB_NAME=$(grep 'CREATE SCHEMA ' ${MYSQL_SCHEMA_FILENAME} | awk -F\` '{print $2}')
	MYSQL_ALERT_LEN=$(grep VARCHAR ${MYSQL_SCHEMA_FILENAME} | awk -F\( '{print $2}' | awk -F\) '{print $1}')

	mysql -uroot -p${MYSQL_PASSWORD} < ${MYSQL_SCHEMA_FILENAME}
}

function create_EA_alert_rules {
	echo '[*] Install ElastAlert rules'
	apt-get install python-dev mailutils -y
	# See https://elastalert.readthedocs.org/en/latest/ruletypes.html for more details.
	# Seel also https://elastalert.readthedocs.org/en/latest/recipes/writing_filters.html#writingfilters
	local RULES_DIR=$1
	[ -z "${RULES_DIR}" ] && RULES_DIR=/etc/elastalert/rules
	local CMD_DIR=$(dirname ${RULES_DIR})/commands
	mkdir -p ${RULES_DIR}
	mkdir -p ${CMD_DIR}

	# Snort alert for priority 1
	local CMD_GENERIC_ALERT=${CMD_DIR}/generic_alert_elastalert
	local RULE_SNORT_ALERT_PRIO1=${RULES_DIR}/snort_prio_1.yaml

	mv ${INSTALL_FILES_DIR}/elastalert/snort_prio_1.yaml ${RULE_SNORT_ALERT_PRIO1}
	sed -i "s|CMD_GENERIC_ALERT|${CMD_GENERIC_ALERT}|" ${RULES_DIR}/snort_prio_1.yaml

	# Install MySQL and the schema for the alerts
	install_mysql
	create_alert_schema_mysql

	local LOG_REALERT_TIME=15
	local MAIL_CMD=$(which mail 2>/dev/null)

	# Create parameters files for generic alert.
	local GENERIC_ALERTS_CONF_PATH=/etc/generic_alert.conf
	echo "LOGFILE=/var/log/alerts" >> ${GENERIC_ALERTS_CONF_PATH}
	echo "EMAIL_FROM=${ALERT_EMAIL}" >> ${GENERIC_ALERTS_CONF_PATH}
	echo "LOGIN=root" >> ${GENERIC_ALERTS_CONF_PATH}
	echo "PASSWORD=${MYSQL_PASSWORD}" >> ${GENERIC_ALERTS_CONF_PATH}
	echo "DB=${MYSQL_DB_NAME}" >> ${GENERIC_ALERTS_CONF_PATH}
	echo "#LOG_REALERT_TIME=${LOG_REALERT_TIME}" >> ${GENERIC_ALERTS_CONF_PATH}
	chmod 600 ${GENERIC_ALERTS_CONF_PATH}

	apt-get install libjansson-dev build-essential zlib1g-dev libmysqld-dev -y
	# If we need to reproduce builds, try using --no-insert-timestamp, -frandom-seed=string, -fno-guess-branch-probability
	# https://lists.debian.org/debian-devel/2005/02/msg01154.html
	gcc $(mysql_config --cflags) -DMAIL_CMD=\"${MAIL_CMD}\" -DDEFAULT_LOG_REALERT_TIME=${LOG_REALERT_TIME} -DCONF_PATH=\"${GENERIC_ALERTS_CONF_PATH}\" -DMYSQL_ALERT_LEN=${MYSQL_ALERT_LEN} -Wall -fvisibility=hidden -O3 -s -o ${CMD_GENERIC_ALERT} ${INSTALL_FILES_DIR}/elastalert/generic_alert_elastalert.c $(mysql_config --libs) -ljansson -lm
}

function install_elastalert {
	echo '[*] Installing ElastAlert'
	# https://elastalert.readthedocs.org/en/latest/running_elastalert.html
	local EA_BASEDIR=/etc/elastalert
	local RULES_DIR=${EA_BASEDIR}/rules
	local CONFIG_FILE="${EA_BASEDIR}/config.yaml"
	local EA_VERSION="0.0.94"

	# Install elastalert
	# Note: It doesn't work yet with python3 - see #145
	apt-get install libyaml-dev build-essential python-yaml python-pip python-dateutil python-setuptools python-simplejson python-jsonschema python-blist -y
	pip install --upgrade --force setuptools
	pip install --upgrade --force six
	pip install jira
	pip install PyStaticConfiguration
	cd /usr/local/src
	wget https://github.com/Yelp/elastalert/archive/v${EA_VERSION}.tar.gz
	tar -zxf v${EA_VERSION}.tar.gz
	rm v${EA_VERSION}.tar.gz
	cd elastalert-${EA_VERSION}
	python setup.py install

	# Set-up
	mkdir -p ${EA_BASEDIR}
	cp config.yaml.example ${CONFIG_FILE}

	# Configure
	sed -i "s|rules_folder: example_rules|rules_folder: ${RULES_DIR}|" ${CONFIG_FILE}
	sed -i "s/es_host: elasticsearch.example.com/es_host: 127.0.0.1/" ${CONFIG_FILE}

	# Make sure elasticsearch is started
	service elasticsearch start
	# and wait a little while
	sleep 15

	# Create index
	local EA_INDEX=$(grep 'elastalert_status' ${CONFIG_FILE} | awk '{print $2}')
	# --no-ssl is buggy: https://github.com/Yelp/elastalert/issues/211
	elastalert-create-index --host 127.0.0.1 --port 9200 --no-ssl --no-auth --index ${EA_INDEX} --url-prefix '' --old-index ''

	# Create basic rules
	create_EA_alert_rules ${RULES_DIR}

	# Make it a service
	local SERVICE_FILE=${SYSTEMD_BASE_DIR}/ElastAlert.service
	mkdir -p ${SYSTEMD_BASE_DIR}
	chmod 755 ${SYSTEMD_BASE_DIR}
	mv ${INSTALL_FILES_DIR}/elastalert/$(basename ${SERVICE_FILE}) ${SERVICE_FILE}
	systemctl daemon-reload
	systemctl enable $(basename ${SERVICE_FILE})
}

function add_iptables {
	echo '[*] Installing iptables script'
	local IPTABLES_SCRIPT='/etc/network/if-up.d/iptables'
	mv ${INSTALL_FILES_DIR}/iptables/iptables ${IPTABLES_SCRIPT}
	chmod +x ${IPTABLES_SCRIPT}
	fromdos ${IPTABLES_SCRIPT}
}

function install_openvas {
	# Note: REQUIRE NGINX
	echo '[*] Installing OpenVAS'
	apt install software-properties-common sqlite3 debconf-utils -y
	add-apt-repository ppa:mrazavi/openvas -y
	apt-get update

	## Add it to auto-update
	[ -z "$(grep openvas /etc/apt/apt.conf.d/50unattended-upgrades)" ] && sed -i 's/Unattended-Upgrade::Allowed-Origins {/Unattended-Upgrade::Allowed-Origins {\n\t"LP-PPA-mrazavi-openvas:xenial";/' /etc/apt/apt.conf.d/50unattended-upgrades

	echo "openvas-scanner openvas-scanner/enable_redis select true" | debconf-set-selections
	DEBIAN_FRONTEND=noninteractive apt-get install openvas -y

	# Prevent GSA from listening to all (and on 80+443 which would prevent Kibana from working)
	local GSA_DEFAULTS_FILENAME=$(grep 'DESC=' /etc/init.d/openvas-gsa | awk -F\" '{print $2}')
	echo 'DAEMON_ARGS="--http-only --listen=127.0.0.1 -p 9392"' > /etc/default/${GSA_DEFAULTS_FILENAME}
	# Default login/pass: admin/admin

	# Add weekly cronjob
	local OPENVAS_CRONJOB=/etc/cron.weekly/openvas
	mv ${INSTALL_FILES_DIR}/openvas/openvas.cron.weekly ${OPENVAS_CRONJOB}
	chmod +x ${OPENVAS_CRONJOB}
	fromdos ${OPENVAS_CRONJOB}

	if [ ${SKIP_OPENVAS_UPDATE} -eq 0 ]; then
		# Execute it
		echo '[*] Getting OpenVAS data. It will take about an hour, 700Mb need to be downloaded and processed'
		bash ${OPENVAS_CRONJOB}
	else
		echo "Skipping updating OpenVAS data."
		echo "Note: It will need to be done before using it."
	fi
}

function base_install {
	echo 'Installing base system'

	if [ ! -f .updated ]; then
		# Check internet is up before starting the script
		WaitForRoutes 60
		if [ $? -eq 0 ]; then
			echo 'Internet is down (no routes). Aborting.'
			exit 1
		fi
		isInternetUp 3
		if [ $? -eq 0 ]; then
			echo 'Internet is down (websites inaccessible). Aborting.'
			exit 1
		fi

		# Wait for apt-get to finish
		local WAIT_APT=1
		sleep 2
		while [ 1 ]; do
			WAIT_APT=$(ps faux | grep -E '(apt|dpkg)' | grep -v grep | wc -l)
			[ ${WAIT_APT} -eq 0 ] && break
			echo "Waiting for APT to finish"
			sleep 10
		done

		fix_potential_apt_issues

		# Install Aptitude
		apt-get install aptitude -y

		# Temporarily remove molly-guard
		apt-get remove molly-guard -y

		# Require reboot
		install_kdump
		NEED_REBOOT=1

		echo "[*] Updating and rebooting"

		# Ubuntu does not seem to add reboot-required file anymore even if a new kernel is installed (might be a bug).
		# Solution: Check how many kernels we have before update ...
		AMOUNT_KERNELS=$(ls /boot/vmlinuz-* | wc -l)

		UPGRADES_AVAIL=$(aptitude -s -y full-upgrade | grep -E '^[0-9]{1,} package[s]? upgraded, ' | awk '{ print $1}')
		if [ ${UPGRADES_AVAIL} -gt 0 ]; then
			# Grub-pc can sometimes open a ncurse window. It happened when running aptitude full-upgrade
			# but didn't when running apt-get install grub-pc then full-upgrade.
			# It asked what to do about /etc/default/grub (and wanted to add) "crashkernel=384M-:128M" to GRUB_CMDLINE_LINUX_DEFAULT
			DEBIAN_FRONTEND=noninteractive apt-get -y -o Dpkg::Options::="--force-confnew" dist-upgrade
		fi

		# Rename network interfaces to ethX due to snort package issue (there might be a comment later in this script about it)
		if [ -n "$(ifconfig -a | grep 'encap:Ethernet' | grep -v '^eth[0-9]')" ]; then
			echo "Renaming network interfaces to ethX"
			apt-get install biosdevname -y

			NEED_REBOOT=1

			GRUB_CMDLINE_LINUX_DEFAULT=$(grep 'GRUB_CMDLINE_LINUX_DEFAULT=' /etc/default/grub | grep -Po '".*?"' | tail -c +2 | head -c -2)
			grep -v 'GRUB_CMDLINE_LINUX_DEFAULT=' /etc/default/grub > /etc/default/grub.tmp
			mv /etc/default/grub.tmp /etc/default/grub
			APPEND_TEXT="net.ifnames=0"
			if [ -n "${GRUB_CMDLINE_LINUX_DEFAULT}" ]; then
				echo "GRUB_CMDLINE_LINUX_DEFAULT=\"${GRUB_CMDLINE_LINUX_DEFAULT} ${APPEND_TEXT}\"" >> /etc/default/grub
			else
				echo "GRUB_CMDLINE_LINUX_DEFAULT=\"${APPEND_TEXT}\"" >> /etc/default/grub
			fi
			update-grub

			# Now save which interface have which mac
			ifconfig -a | grep -E 'Link encap:Ethernet' | awk '{ print $1 "=\"" $5 "\"" }' > .mac
		fi

		# ... and after. If the number is different, we might want to update
		if [ -f /var/run/reboot-required ] || [ ${AMOUNT_KERNELS} -ne $(ls /boot/vmlinuz-* | wc -l) ] || [ ${NEED_REBOOT} -gt 0 ]; then
			cd ${CURRENT_DIR}
			touch .updated

			# Auto-restart script after reboot
			echo "Automatically restarting the script after reboot"
			if [ -z "$(grep @reboot /var/spool/cron/crontabs/root 2>/dev/null)" ]; then
				local CRONJOB_PARAMS="--from-email ${FROM_EMAIL} --alert-email ${ALERT_EMAIL}"
				if [ ${ND_INSTALL} -eq 1 ]; then
					CRONJOB_PARAMS="${CRONJOB_PARAMS} --install defender"
				elif [ ${LOG_INSTALL} -eq 1 ]; then
					CRONJOB_PARAMS="${CRONJOB_PARAMS} --installer logger"
				else
					CRONJOB_PARAMS="${CRONJOB_PARAMS} --installer base"
				fi
				[ ${SKIP_OPENVAS_UPDATE} -eq 1 ] && CRONJOB_PARAMS="${CRONJOB_PARAMS} --openvas-update No"
				[ -n "${EMAIL_PROVIDER}" ] && CRONJOB_PARAMS="${CRONJOB_PARAMS} --email-provider ${EMAIL_PROVIDER}"
				[ -n "${EMAIL_PASSWORD}" ] && CRONJOB_PARAMS="${CRONJOB_PARAMS} --email-password '${EMAIL_PASSWORD}'"
				[ -n "${CERT_SUBJECT_LINE}" ] && CRONJOB_PARAMS="${CRONJOB_PARAMS} --cert-subject '${CERT_SUBJECT_LINE}'"
				[ ${FORCE_INSTALL} -eq 1 ] && CRONJOB_PARAMS="${CRONJOB_PARAMS} --force-install Yes"
				echo "@reboot export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin && cd ${CURRENT_DIR} && bash ${0} ${CRONJOB_PARAMS} >>/var/log/netforce_install.log 2>&1 " >> /var/spool/cron/crontabs/root
				chmod 600 /var/spool/cron/crontabs/root
				chown root.crontab /var/spool/cron/crontabs/root
			fi

			reboot
			exit 0
		fi
	fi

	if [ -f .mac ]; then
		for iface in $(ifconfig -a | grep -E 'Link encap:Ethernet' | awk '{ print $1}')
		do
			MAC=$(ifconfig ${iface} | grep -E 'Link encap:Ethernet' | awk '{ print $5}')
			OLD_IFACE=$(grep "${MAC}" .mac | awk -F= '{print $1}')
			if [ -z ${OLD_IFACE} ]; then
				echo "Mac might have changed. No old interface with MAC ${MAC}. Check out mac.old"
				cp .mac mac.old
				continue
			fi
			echo "Updating network settings for ${iface} (old: ${OLD_IFACE})"
			# Edit /etc/network/interfaces
			sed -i "s/^iface ${OLD_IFACE} inet /iface ${iface} inet /" /etc/network/interfaces
			sed -i "s/^auto ${OLD_IFACE}/auto ${iface}/" /etc/network/interfaces
		done
		rm .mac
		echo "Done ... rebooting"
		reboot
		exit 0
	fi

	rm .updated

	fix_blk_update_request_fd0_errors

	# If there is more than one kernel, we might want to remove the old stuff (now since it's updated)
	if [ $(ls /boot/vmlinuz-* | wc -l) -gt 1 ]; then
		apt-get remove -y --purge $(dpkg -l 'linux-image-*' | sed '/^ii/!d;/'"$(uname -r | sed "s/\(.*\)-\([^0-9]\+\)/\1/")"'/d;s/^[^ ]* [^ ]* \([^ ]*\).*/\1/;/[0-9]/!d')
		apt-get autoremove -y
	fi

	# Remove entry in crontab
	if [ -f /var/spool/cron/crontabs/root ] && [ $(grep '@reboot' /var/spool/cron/crontabs/root | wc -l) -eq 1 ]; then
		grep -v '@reboot' /var/spool/cron/crontabs/root > /var/spool/cron/crontabs/root.tmp
		mv /var/spool/cron/crontabs/root.tmp /var/spool/cron/crontabs/root
	fi

	# Check internet is up before starting the script
	WaitForRoutes 60
	if [ $? -eq 0 ]; then
		echo 'Internet is down (no routes). Aborting.'
		exit 1
	fi
	isInternetUp 3
	if [ $? -eq 0 ]; then
		echo 'Internet is down (websites inaccessible). Aborting.'
		exit 1
	fi

	# Workaround for #12
	apt-get purge ssh-import-id -y
	apt-get autoremove -y
	apt-mark hold ssh-import-id
	# Install some useful tools
	DEBIAN_FRONTEND=noninteractive apt-get install ethtool screen traceroute htop iotop sysstat tcpdump tshark bwm-ng fail2ban  openssh-server tofrodos -y

	cleanup_install_path

	install_psmem
	install_ntp
	add_sysuser_if_not_exist

	show_ip_login
	install_autochmod

	# RKhunter installs autochmod and postfix
	install_rkhunter
	
	improve_ssh_security
	install_regenerate_ssh_keys
	autoreboot_when_kernel_panic
	setup_auto_updates
	increase_network_memory
	disable_power_button

	install_elasticsearch
	# Note: Kibana install depends on Elasticsearch (due to dashboard)
	install_kibana
	# Logstash install must be done after Kibana because we'll run that script to install Logstash (we don't want it to run Kibana Install)
	install_logstash

	install_nginx
	install_curator
	install_elastalert

	install_monit

	install_openvas
	install_ntopng

	add_iptables

	update_motd
}

function install_oinkmaster {
	echo '[*] Installing oinkmaster and snort rules update scripts'
	if [ -d /etc/snort ]; then
		cd /etc/snort

		# Move old rules to another dir and recreate directory
		mv rules old-rules
		mkdir rules
	fi
	if [ -d /etc/suricata ]; then
		cd /etc/suricata

		# Move old rules to another dir and recreate directory
		mv rules old-rules
		mkdir rules
	fi

	# Oinkmaster should already be installed
	apt-get install oinkmaster patch -y

	# Prevent updates to oinkmaster (there shouldn't be any since it hasn't been updated for years)
	apt-mark hold oinkmaster

	# Patch oinkmaster so it just tries a few times before stopping
	# XXX: Should I prevent from being updated? I don't think so, it shouldn't fails getting the rules later on.
	fromdos ${INSTALL_FILES_DIR}/oinkmaster/oinkmaster.diff
	patch -N -i ${INSTALL_FILES_DIR}/oinkmaster/oinkmaster.diff -d /usr/sbin/

	# Add cron job to get the rules
	local RULES_UPDATE_SCRIPT=/etc/scripts/updateIDSRules
	mkdir -p /etc/scripts
	mv ${INSTALL_FILES_DIR}/oinkmaster/updateIDSRules ${RULES_UPDATE_SCRIPT}
	chmod +x ${RULES_UPDATE_SCRIPT}
	fromdos ${RULES_UPDATE_SCRIPT}

	# Get rules for the first time
	echo "Updating IDS rules via oinkmaster. It might take a while"
	/etc/scripts/updateIDSRules
	echo "Done updating IDS rules via oinkmaster"

	# See https://github.com/logstash-plugins/logstash-filter-json/issues/15
	[ -d /etc/suricata ] && [ -z "$(ls -1 /etc/suricata/rules 2>/dev/null)" ] && echo "Failed to download (suricata) rules. Check /var/log/oinkmaster.log for details and reinstall the rules."
	[ -d /etc/snort ] && [ -z "$(ls -1 /etc/snort/rules 2>/dev/null)" ] && echo "Failed to download (snort) rules. Check /var/log/oinkmaster.log for details and reinstall the rules."

	echo "5 20 * * *    root    ${RULES_UPDATE_SCRIPT}" >> /etc/crontab
	# XXX: Do not restart cron, it makes the whole script crash on 16.04 (works fine on 14.04)
	#      It will be restarted no matter what at the end of this script (due to reboot).
	# It seems like cron in 16.04 is now killing all its children when restarted where 14.04 didn't
	#service cron restart
}

function add_generic_alert_elastalert {
	echo '[*] Installing Generic alart for ElastAlert'
	local EA_BASEDIR=/etc/elastalert
	local RULES_DIR=${EA_BASEDIR}/rules
	local CMD_DIR=$(dirname ${RULES_DIR})/commands

	# Snort alert for priority 1
	local CMD_GENERIC_ALERT=${CMD_DIR}/generic_alert_elastalert
	local RULE_GENERIC_LOG_ALERT=${RULES_DIR}/generic_log_alert.yaml

	mv ${INSTALL_FILES_DIR}/elastalert/generic_log_alert.yaml ${RULE_GENERIC_LOG_ALERT}
	sed -i "s|CMD_GENERIC_ALERT|${CMD_GENERIC_ALERT}|" ${RULE_GENERIC_LOG_ALERT}
	fromdos ${RULE_GENERIC_LOG_ALERT}
}

function install_vm_tools {
	# http://www.dmo.ca/blog/detecting-virtualization-on-linux/
	if [ -n "$(lspci | grep VMware)" ] || [ -n "$(lspci | grep 'Hyper-V')" ]; then
		[ -n "$(lspci | grep VMware)" ] && echo "VMware detected, installing Open VM Tools"
		[ -n "$(lspci | grep 'Hyper-V')" ] && echo "Hyper-V detected, installing Open VM Tools"
		apt-get install open-vm-tools -y
	fi
	if [ -n "$(lspci | grep -i VirtualBox)" ]; then
		apt-get install virtualbox-guest-dkms -y
	fi
}

###############################################    FUNCTIONS - End  ###############################################

if [ $(lsb_release -i -s | grep -i ubuntu | wc -l) -eq 0 ]; then
	echo 'This installation script only works on Ubuntu. Aborting'
	exit 1
fi

UBUNTU_VER=$(lsb_release -r -s)

if [ "${UBUNTU_VER}" != '16.04' ]; then
	echo 'This installation script only works on Ubuntu 16.04. Aborting'
	exit 1
elif [ $(file /lib/systemd/systemd | grep -i '64-bit' | wc -l) -eq 0 ]; then
	echo 'This installation script only works on 16.04 64 bit. Aborting'
	exit 1
fi



# Check parameters
ND_INSTALL=1
ND_INSTALLED=0
LOG_INSTALL=0
LOG_INSTALLED=0
BASE_INSTALL=1
SKIP_OPENVAS_UPDATE=0
FORCE_INSTALL=0
FROM_EMAIL=myemail@example.com
ALERT_EMAIL=myemail@example.com
EMAIL_PROVIDER="office365"
EMAIL_PASSWORD=""
CERT_SUBJECT_LINE=""

EMAIL_REGEXP="^[a-z0-9!#\$%&'*+/=?^_\`{|}~-]+(\.[a-z0-9!#$%&'*+/=?^_\`{|}~-]+)*@([a-z0-9]([a-z0-9-]*[a-z0-9])?\.)+[a-z0-9]([a-z0-9-]*[a-z0-9])?\$"

while [[ $# -gt 1 ]]
do
	key="$1"

	case $key in
		--install)
			if [[ $2 =~ ^- ]]; then
				echo "Missing parameter in install type, aborting."
				exit 1
			fi
			if [ "${2^^}" =  "BASE" ]; then
				ND_INSTALL=0
				LOG_INSTALL=0
			elif [ "${2^^}" =  "DEFENDER" ]; then
				ND_INSTALL=1
				LOG_INSTALL=0
			elif [ "${2^^}" =  "LOGGER" ] || [ "$2^^" =  "LOG" ]; then
				ND_INSTALL=0
				LOG_INSTALL=1
			else
				echo "Unknown parameter: $2. Valid values: base, defender, logger"
				exit 1
			fi
			shift
			;;
		--openvas-update)
			if [[ $2 =~ ^- ]]; then
				echo "Missing parameter in OpenVAS update, aborting."
				exit 1
			fi
			if [[ "${2^^}" =~ (NO?|FALSE|0) ]]; then
				SKIP_OPENVAS_UPDATE=1
			elif ! [[ "${2^^}" =~ (Y(ES)?|TRUE|1) ]]; then
				echo "Invalid value. Expected one of the following: Yes or No"
				exit 1
			fi
			shift
			;;
		--from-email)
			if [[ $2 =~ ^- ]]; then
				echo "Missing parameter in from email, aborting."
				exit 1
			fi
			if [[ $2 =~ ${EMAIL_REGEXP} ]]; then
				FROM_EMAIL="$2"
			else
				echo "Invalid email address <${2}>, aborting."
				exit 1
			fi
			shift
			;;
		--alert-email)
			if [[ $2 =~ ^- ]]; then
				echo "Missing parameter in alert email, aborting."
				exit 1
			fi
			if [[ $2 =~ ${EMAIL_REGEXP} ]]; then
				ALERT_EMAIL="$2"
			else
				echo "Invalid email address <${2}>, aborting."
				exit 1
			fi
			shift
			;;
		--email-provider)
			if [[ $2 =~ ^- ]]; then
				echo "Missing parameter in email provider, aborting."
				exit 1
			fi
			if [ "$2" == "gmail" ] || [ "$2" == "office365" ]; then
				EMAIL_PROVIDER="$2"
			else
				echo "Valid email providers: gmail or office365"
				echo "Aborting."
				exit 1
			fi
			shift
			;;
		--email-password)
			if [ -z "$2" ]; then
				# Can't really validate password since it could start with --
				echo "Missing password, aborting."
				exit 1
			fi
			EMAIL_PASSWORD="$2"
			shift
			;;
		--cert-subject)
			if [[ $2 =~ ^- ]]; then
				echo "Missing parameter in certificate subject, aborting."
				exit 1
			fi
			CERT_SUBJECT_LINE="$2"
			shift
			;;
		--force-install)
			if [[ $2 =~ ^- ]]; then
				echo "Missing parameter in force install, aborting."
				exit 1
			fi
			if [[ "${2^^}" =~ (Y(ES)?|TRUE|1) ]]; then
				FORCE_INSTALL=1
			elif ! [[ "${2^^}" =~ (NO?|FALSE|0) ]]; then
				echo "Invalid value. Expected one of the following: Yes or No"
				exit 1
			fi
			shift
			;;
		*)
			echo "Unkown option (${key}), aborting"
			exit 1
			;;
	esac
	shift
done

# Check what's installed now
if [ $(grep 'Netforce Defender' ${ETC_MAINNERVE} 2>/dev/null | wc -l) -eq 1 ]; then
	echo 'Netforce Defender is currently installed'
	ND_INSTALLED=1
	BASE_INSTALL=0
elif [ $(grep 'Netforce Logger' ${ETC_MAINNERVE} 2>/dev/null | wc -l) -eq 1 ]; then
	echo 'Netforce Logger is currently installed'
	LOG_INSTALLED=1
	BASE_INSTALL=0
fi

MEM_TOTAL=$(free -m | grep -E '^Mem' | awk '{print $2}')
ENOUGH_MEM=0
MEM_RECOMMENDED=0
[ ${MEM_TOTAL} -gt 3700 ] && ENOUGH_MEM=1
[ ${MEM_TOTAL} -gt 7700 ] && MEM_RECOMMENDED=1
DISK_LEFT=$(df -m | grep -E '/$' | awk '{print $4}')
ENOUGH_DISK=0
[ ${DISK_LEFT} -gt 100000 ] && ENOUGH_DISK=1

# Display settings
echo "Settings:"
TEMP_STR=$(echo "(Enough? ${ENOUGH_MEM} - Above recommended? ${MEM_RECOMMENDED})" | sed -e 's/1/Yes/g' -e 's/0/No/g')
echo "- Memory: ${MEM_TOTAL}Mb ${TEMP_STR}"
TEMP_STR=$(echo "(Enough? ${ENOUGH_DISK})" | sed -e 's/1/Yes/g' -e 's/0/No/g')
echo "- Hard disk space left: ${DISK_LEFT}Mb ${TEMP_STR}"
echo "- Base install: ${BASE_INSTALL}" | sed -e 's/1/Yes/g' -e 's/0/No/g'
echo "- Netforce Defender install: ${ND_INSTALL} (Installed: ${ND_INSTALLED})" | sed -e 's/1/Yes/g' -e 's/0/No/g'
echo "- Netforce Logger install: ${LOG_INSTALL} (Installed: ${LOG_INSTALLED})" | sed -e 's/1/Yes/g' -e 's/0/No/g'
if [ ${SKIP_OPENVAS_UPDATE} -eq 1 ]; then
	echo "- Skipping OpenVAS data update"
else
	echo "- Doing OpenVAS data update"
fi
echo "- From email: ${FROM_EMAIL}"
if [ -n "${EMAIL_PASSWORD}" ]; then
	echo "- Password present"
else
	echo "- Password not provided"
fi
echo "- Alert email: ${ALERT_EMAIL}"
echo "- Email provider: ${EMAIL_PROVIDER}"
if [ -n "${CERT_SUBJECT_LINE}" ]; then
	echo "- Custom Nginx certificate subject: ${CERT_SUBJECT_LINE}"
else
	echo "- Using default certificate subject with email address: ${ALERT_EMAIL}"
fi

# Some more checks
if [ ${ND_INSTALL} -eq 0 ] && [ ${LOG_INSTALL} -eq 0 ]; then
	echo 'Cannot remove all and install base. Aborting'
	exit 1
elif [ ${ND_INSTALL} -eq 1 ] && [ ${ND_INSTALLED} -eq 1 ]; then
	echo 'Netforce Defender is already installed. Nothing to be done'
	exit 0
elif [ ${LOG_INSTALL} -eq 1 ] && [ ${LOG_INSTALLED} -eq 1 ]; then
	echo 'Netforce Logger is already installed. Nothing to be done'
	exit 0
elif [ ${ND_INSTALLED} -eq 1 ] || [ ${LOG_INSTALLED} -eq 1 ]; then
	# Don't allow removing everything and just keeping the base
	if [ ${ND_INSTALL} -eq 0 ] && [ ${LOG_INSTALL} -eq 0 ]; then
		echo 'It allows to switch from one install to another but not remove it completely'
		exit 1
	fi
fi

# Check minimum requirements
if [ ${FORCE_INSTALL} -eq 0 ]; then
	if [ ${ENOUGH_MEM} -eq 0 ]; then
		echo 'Not enough memory, aborting install.'
		exit 1
	elif [ ${ENOUGH_DISK} -eq 0 ]; then
		echo 'Not enough disk space for logs, aborting install.'
		exit 1
	fi
elif [ ${ENOUGH_MEM} -eq 0 ] || [ ${ENOUGH_DISK} -eq 0 ]; then
	echo "WARNING: Forcing install even though the system does not have the minimum requirements"
fi

if [ ${BASE_INSTALL} -eq 1 ]; then
	base_install $1
	echo 'Base install done, now installing what is requested'
else
	# Check internet is up before starting the script
	WaitForRoutes 60
	if [ $? -eq 0 ]; then
		echo 'Internet is down (no routes). Aborting.'
		exit 1
	fi
	isInternetUp 3
	if [ $? -eq 0 ]; then
		echo 'Internet is down (websites inaccessible). Aborting.'
		exit 1
	fi

	cleanup_install_path
fi


if [ ${LOG_INSTALL} -eq 0 ]; then
	install_snort
	install_oinkmaster
elif [ ${ND_INSTALLED} -eq 1 ]; then
	DEBIAN_FRONTEND=noninteractive apt-get purge snort oinkmaster -y --allow-change-held-packages
	rm -rf /etc/snort /etc/scripts/updateIDSRules /etc/elastalert/rules/snort_prio_1.yaml /etc/logstash/conf.d/input-snort.conf
	grep -v 'updateIDSRules' /etc/crontab > /etc/crontab.bak
	mv /etc/crontab.bak /etc/crontab
	chmod 644 /etc/crontab
fi

# It will install the files for the chosen installation type
configure_logstash

add_generic_alert_elastalert

install_vm_tools

store_version_installed

EXTRA_FILE="$(dirname ${THIS_FILE})/extra.sh"
if [ -f ${EXTRA_FILE} ]; then
	echo '---------------------- Something extra is to be installed ---------------'
	fromdos ${EXTRA_FILE}
	chmod +x ${EXTRA_FILE}
	bash ${EXTRA_FILE}
	echo "Return value of ${EXTRA_FILE}: $?"
	echo '--------------------- Extra Installation Complete ---------------------'
fi

# Reinstall Molly-guard to prevent accidental reboot
apt-get install molly-guard -y --allow-unauthenticated

echo '--------------------- Installation Complete ---------------------'

rm ${THIS_FILE}
rm -rf "${INSTALL_FILES_DIR}" "$(dirname ${THIS_FILE})/LICENSE" "$(dirname ${THIS_FILE})/README.md" "$(dirname ${THIS_FILE})/.gitignore" "$(dirname ${THIS_FILE})/login_prompt.png"
reboot